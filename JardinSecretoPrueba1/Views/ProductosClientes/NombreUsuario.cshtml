@{
    ViewData["Title"] = "Datos del Cliente";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="card-title text-center text-success mb-4">¡Bienvenido! 🌿</h3>
                <p class="text-center text-muted mb-4">Ingrese sus datos para continuar</p>

                <!-- Formulario -->
                <form asp-action="NombreUsuario" method="post">

                    <!-- Nombre -->
                    <div class="mb-3">
                        <label for="nombreUsuario" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombreUsuario" name="nombreUsuario" required />
                    </div>

                    <!-- Apellido -->
                    <div class="mb-3">
                        <label for="apellidoUsuario" class="form-label">Apellido</label>
                        <input type="text" class="form-control" id="apellidoUsuario" name="apellidoUsuario" required />
                    </div>

                    <!-- Teléfono -->
                    <div class="mb-3">
                        <label for="telefonoUsuario" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="telefonoUsuario" name="telefonoUsuario"
                               pattern="[0-9]{8}" maxlength="8" placeholder="Ejemplo: 77778888" required />
                    </div>

                    <!-- Tipo de pedido -->
                    <div class="mb-3">
                        <label class="form-label">Tipo de pedido</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipoPedido" id="delivery" value="Delivery" required />
                            <label class="form-check-label" for="delivery">Delivery</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipoPedido" id="recoger" value="Pasar a recoger" />
                            <label class="form-check-label" for="recoger">Pasar a recoger</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="tipoPedido" id="comer" value="Comer en restaurante" />
                            <label class="form-check-label" for="comer">Comer en restaurante</label>
                        </div>
                    </div>

                    <!-- Dirección (solo visible si elige Delivery) -->
                    <div class="mb-3" id="direccionContainer" style="display: none;">
                        <label for="direccionUsuario" class="form-label">Dirección de entrega</label>
                        <textarea class="form-control" id="direccionUsuario" name="direccionUsuario" rows="3"
                                  placeholder="Ejemplo: Calle Los Laureles #12, Col. San Benito"></textarea>
                    </div>
                    <!-- Hora (solo para recoger o comer en restaurante) -->
                    <div class="mb-3" id="horaContainer" style="display:none;">
                    <label for="horaPedido" class="form-label">Hora (Horario: 4 PM - 2 AM, cerrado miércoles)</label>
                    <input type="time" class="form-control" id="horaPedido" name="horaPedido" />
                    <span id="horaError" class="text-danger small d-block mt-1"></span> 
                    </div>

                    <!-- Botón -->
                    <button type="submit" class="btn btn-success w-100">Continuar</button>
                </form>

                <div class="text-center mt-3">
                    <a asp-controller="Home" asp-action="Index">Volver al inicio</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para mostrar/ocultar dirección -->
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // --- Tu script existente para mostrar/ocultar ---
            const tipoPedidoRadios = document.querySelectorAll('input[name="tipoPedido"]');
            const direccionContainer = document.getElementById("direccionContainer");
            const horaContainer = document.getElementById("horaContainer");
            const horaInput = document.getElementById("horaPedido"); // Input de la hora
            const horaErrorSpan = document.getElementById("horaError"); // Span de error
            const submitButton = document.querySelector('button[type="submit"]'); // Botón Continuar

            tipoPedidoRadios.forEach(radio => {
                radio.addEventListener("change", () => {
                    const esRecogerOComer = (radio.value === "Pasar a recoger" || radio.value === "Comer en restaurante");
                    
                    direccionContainer.style.display = radio.value === "Delivery" ? "block" : "none";
                    horaContainer.style.display = esRecogerOComer ? "block" : "none";

                    // Hacemos el campo de hora requerido SOLO si está visible
                    horaInput.required = esRecogerOComer; 
                    
                    // Al cambiar el tipo de pedido, revalidamos la hora por si acaso
                    validarHora(); 
                });
            });

            // --- NUEVO SCRIPT PARA VALIDAR LA HORA ---
            
            // Función para validar la hora
            function validarHora() {
                // Solo validamos si el campo de hora está visible
                if (horaContainer.style.display !== 'block' || !horaInput.value) {
                    horaErrorSpan.textContent = ""; // Limpiar error si no aplica o está vacío
                    submitButton.disabled = false; // Habilitar botón
                    return true; // No hay nada que validar
                }

                // Obtener día actual (0=Domingo, 1=Lunes,..., 3=Miércoles)
                // Usamos la hora local del navegador del usuario
                const hoy = new Date();
                const diaSemana = hoy.getDay(); 
                
                // Obtener hora y minutos seleccionados
                const horaSeleccionada = horaInput.value.split(":"); // ["17", "30"]
                const hora = parseInt(horaSeleccionada[0]); // 17
                const minutos = parseInt(horaSeleccionada[1]); // 30

                let esValido = false;
                let mensajeError = "";

                // 1. Validar si es miércoles
                if (diaSemana === 3) { // 3 = Miércoles
                    mensajeError = "El restaurante está cerrado los miércoles.";
                    esValido = false;
                } else {
                    // 2. Validar el rango horario (16:00 a 01:59)
                    // Está abierto si la hora es 16 o más O si es menor que 2
                    const estaEnRango = (hora >= 16 || hora < 2); 
                    
                    if (estaEnRango) {
                        esValido = true;
                    } else {
                        mensajeError = "La hora seleccionada está fuera del horario (4 PM - 2 AM).";
                        esValido = false;
                    }
                }

                // Mostrar/ocultar mensaje de error
                horaErrorSpan.textContent = mensajeError;
                // Deshabilitar/habilitar botón de envío
                submitButton.disabled = !esValido; 

                return esValido;
            }

            // Escuchar cambios en el input de la hora
            horaInput.addEventListener("input", validarHora);

            // Validar la hora inicial al cargar (por si el navegador autocompleta)
            validarHora(); 

        }); // Fin del DOMContentLoaded
    </script>
}
